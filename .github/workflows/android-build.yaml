name: Build Android APK

on:
  push:
    branches: [ "main", "master" ]
  pull_request:

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      ANDROID_ABI: arm64-v8a
      ANDROID_PLATFORM: android-33
      ANDROID_NDK_VERSION: 25.2.9519653
      QT_VERSION: 6.6.2
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64

    steps:
    # ------------------------------------------------------------
    # Checkout
    # ------------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ------------------------------------------------------------
    # Java 17
    # ------------------------------------------------------------
    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'

    # ------------------------------------------------------------
    # Android SDK + NDK
    # ------------------------------------------------------------
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install Android platform & NDK
      run: |
        sdkmanager \
          "platforms;android-33" \
          "build-tools;33.0.2" \
          "ndk;${ANDROID_NDK_VERSION}"

    # ------------------------------------------------------------
    # Qt DESKTOP (WYMAGANE)
    # ------------------------------------------------------------
    - name: Install Qt Desktop
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        target: desktop
        arch: gcc_64
        cache: true

    # ------------------------------------------------------------
    # Qt ANDROID
    # ------------------------------------------------------------
    - name: Install Qt Android
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        target: android
        arch: android_arm64_v8a
        cache: true

    # ------------------------------------------------------------
    # Configure CMake (ANDROID Qt!)
    # ------------------------------------------------------------
    - name: Configure CMake
      run: |
        mkdir build
        cd build

        echo "Qt Android DIR: $Qt6_DIR"

        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=${ANDROID_ABI} \
          -DANDROID_PLATFORM=${ANDROID_PLATFORM} \
          -DCMAKE_PREFIX_PATH=$Qt6_DIR

    # ------------------------------------------------------------
    # Build native code
    # ------------------------------------------------------------
    - name: Build
      run: |
        cd build
        cmake --build . -- -j$(nproc)

    # ------------------------------------------------------------
    # Build APK (androiddeployqt z DESKTOP Qt)
    # ------------------------------------------------------------
    - name: Build APK
      run: |
        cd build

        ANDROIDDEPLOYQT=$(find $Qt6_DIR/../gcc_64 -name androiddeployqt | head -n 1)

        if [ -z "$ANDROIDDEPLOYQT" ]; then
          echo "androiddeployqt not found"
          exit 1
        fi

        $ANDROIDDEPLOYQT \
          --input *deployment-settings.json \
          --output android-build \
          --android-platform android-33 \
          --jdk $JAVA_HOME \
          --gradle

    # ------------------------------------------------------------
    # Upload APK
    # ------------------------------------------------------------
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: kleiner-brauhelfer-apk
        path: build/android-build/**/*.apk
