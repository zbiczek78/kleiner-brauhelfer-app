name: Build Android APK

on:
  push:
    branches: [ "main", "master" ]
  pull_request:

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      ANDROID_ABI: arm64-v8a
      ANDROID_PLATFORM: android-33
      ANDROID_NDK_VERSION: 25.2.9519653
      QT_VERSION: 6.6.2
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64

    steps:
    # ------------------------------------------------------------
    # Checkout repository
    # ------------------------------------------------------------
    - uses: actions/checkout@v4

    # ------------------------------------------------------------
    # Set up Java 17
    # ------------------------------------------------------------
    - uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'

    # ------------------------------------------------------------
    # Android SDK + NDK
    # ------------------------------------------------------------
    - uses: android-actions/setup-android@v3

    - name: Install Android platform & NDK
      run: |
        sdkmanager \
          "platforms;android-33" \
          "build-tools;33.0.2" \
          "ndk;${ANDROID_NDK_VERSION}"

    # ------------------------------------------------------------
    # Install Qt6 Desktop (host tools)
    # ------------------------------------------------------------
    - name: Install Qt6 Desktop
      id: qt-desktop
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        target: desktop
        arch: gcc_64
        cache: true

    # ------------------------------------------------------------
    # Install Qt6 Android (target libraries)
    # ------------------------------------------------------------
    - name: Install Qt6 Android
      id: qt-android
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        target: android
        arch: android_arm64_v8a
        cache: true

    # ------------------------------------------------------------
    # Configure CMake (use Qt6 Android path)
    # ------------------------------------------------------------
    - name: Configure CMake
      run: |
        mkdir build
        cd build

        # Qt6 Android directory
        QT_ANDROID_DIR=${{ steps.qt-android.outputs.qt_dir }}
        QT_ANDROID_CMAKE="$QT_ANDROID_DIR/lib/cmake/Qt6"

        echo "Using Qt6 Android CMake path: $QT_ANDROID_CMAKE"

        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=${ANDROID_ABI} \
          -DANDROID_PLATFORM=${ANDROID_PLATFORM} \
          -DCMAKE_PREFIX_PATH=$QT_ANDROID_CMAKE

    # ------------------------------------------------------------
    # Build native library
    # ------------------------------------------------------------
    - name: Build
      run: |
        cd build
        cmake --build . -- -j$(nproc)

    # ------------------------------------------------------------
    # Build APK using androiddeployqt (from Desktop Qt)
    # ------------------------------------------------------------
    - name: Build APK
      run: |
        cd build

        ANDROIDDEPLOYQT=$(find ${{ steps.qt-desktop.outputs.qt_dir }} -name androiddeployqt | head -n 1)

        if [ -z "$ANDROIDDEPLOYQT" ]; then
          echo "androiddeployqt not found"
          exit 1
        fi

        $ANDROIDDEPLOYQT \
          --input *deployment-settings.json \
          --output android-build \
          --android-platform android-33 \
          --jdk $JAVA_HOME \
          --gradle

    # ------------------------------------------------------------
    # Upload APK as artifact
    # ------------------------------------------------------------
    - uses: actions/upload-artifact@v4
      with:
        name: kleiner-brauhelfer-apk
        path: build/android-build/**/*.apk
