name: Android Qt 6.5.3 Build

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      QT_VERSION: 6.5.3
      # Qt 6.5.3 oficjalnie wspiera NDK r25b lub r26. GitHub zazwyczaj ma kilka wersji.
      # Ustawiamy preferowaną, ale systemowa też powinna zadziałać.
      ANDROID_ARCH: android_arm64_v8a
      ANDROID_TARGET_SDK: 33

    steps:
      # ############################################################
      # 1️⃣ Checkout repository
      # ############################################################
      - name: Checkout repository
        uses: actions/checkout@v4

      # ############################################################
      # 2️⃣ Setup Java (Wymagane dla Gradle/Android)
      # ############################################################
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ############################################################
      # 3️⃣ Install system dependencies (Ninja)
      # ############################################################
      - name: Install Ninja
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build

      # ############################################################
      # 4️⃣ Install Qt (Android Version)
      # ############################################################
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: 'linux'
          target: 'android'
          arch: ${{ env.ANDROID_ARCH }}
          modules: 'qtwebengine qtwebchannel qtpositioning qtserialport'
          cache: 'true' # Przyspiesza kolejne uruchomienia

      # ############################################################
      # 5️⃣ Configure project with CMake
      # ############################################################
      - name: Configure project (CMake)
        run: |
          # jurplel/install-qt-action automatycznie ustawia PATH do binariów Qt
          # Używamy qt-cmake, który jest wrapperem dostarczanym przez Qt
          
          qt-cmake -S . -B build-android \
            -G "Ninja" \
            -DANDROID_PLATFORM=android-${{ env.ANDROID_TARGET_SDK }} \
            -DANDROID_ABI=arm64-v8a \
            -DCMAKE_BUILD_TYPE=Release \
            -DQT_ANDROID_BUILD_ALL_ABIS=OFF 
          
          # Uwaga: Qt 6 zazwyczaj samo wykrywa NDK zainstalowane na GitHub Actions.
          # Jeśli wystąpi błąd NDK, można dodać flagę: -DANDROID_NDK_ROOT=$ANDROID_NDK_HOME

      # ############################################################
      # 6️⃣ Build project
      # ############################################################
      - name: Build project
        run: cmake --build build-android --parallel

      # ############################################################
      # 7️⃣ Deploy APK (Create APK package)
      # ############################################################
      - name: Build APK using androiddeployqt
        run: |
          # W Qt6 często wystarczy cel 'apk' w cmake, ale androiddeployqt daje większą kontrolę
          androiddeployqt \
            --input build-android/android-Qt6_deployment_settings.json \
            --output build-android/android-build \
            --android-platform android-${{ env.ANDROID_TARGET_SDK }} \
            --gradle \
            --release
            
            # Uwaga: Flaga --release stworzy APK, ale będzie ono niepodpisane (unsigned),
            # chyba że w build.gradle skonfigurowano keystore.

      # ############################################################
      # 8️⃣ Upload APK artifact
      # ############################################################
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: kleiner-brauhelfer-app-android-apk
          # Ścieżka zależy od tego, gdzie gradle wypluje plik. Standardowo w build/outputs
          path: build-android/android-build/build/outputs/apk/release/*.apk
          if-no-files-found: error
