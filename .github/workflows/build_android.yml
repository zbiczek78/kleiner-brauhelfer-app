name: Build Android APK

on:
  push:
    branches:
      - master
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      QT_VERSION: "6.10"
      ANDROID_SDK_ROOT: ${{ github.workspace }}/Android/Sdk
      ANDROID_NDK_ROOT: ${{ github.workspace }}/Android/Sdk/ndk-bundle
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Android SDK & NDK
        uses: android-actions/setup-android@v2
        with:
          sdk: "platform-tools,platforms;android-33,build-tools;33.0.2"
          ndk: "latest"
          cache: true

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          target: android
          # arch może być android_armv7 albo android_arm64_v8a, w zależności od Twoich potrzeb
          arch: android_arm64_v8a

      - name: Configure project with CMake for Android
        run: |
          mkdir build-android
          cd build-android
          ${HOME}/Qt/${{ env.QT_VERSION }}/android_arm64_v8a/bin/qt-cmake \
            -DANDROID_SDK_ROOT=${{ env.ANDROID_SDK_ROOT }} \
            -DANDROID_NDK_ROOT=${{ env.ANDROID_NDK_ROOT }} \
            -DCMAKE_BUILD_TYPE=Release \
            -S .. \
            -B . \
            -GNinja

      - name: Build APK
        run: |
          cd build-android
          ninja

      - name: Create APK using androiddeployqt (if needed)
        run: |
          cd build-android
          ${HOME}/Qt/${{ env.QT_VERSION }}/android_arm64_v8a/bin/androiddeployqt \
            --input build/YourAppName.json \
            --output output/android \
            --deployment bundled \
            --release \
            --jdkpath ${{ env.JAVA_HOME }}

      - name: Upload APK artifact
        uses: actions/upload-artifact@v3
        with:
          name: kleiner-brauhelfer-app-android
          path: build-android/output/android/*.apk
