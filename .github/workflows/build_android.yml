name: Build Android (Qt 6.10)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare environment variables
        run: |
          echo "ANDROID_SDK_ROOT=${RUNNER_TEMP}/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=${RUNNER_TEMP}/android-ndk" >> $GITHUB_ENV
          echo "QT_INSTALL_DIR=${RUNNER_TEMP}/qt6" >> $GITHUB_ENV
          echo "QT_VERSION=6.10.0" >> $GITHUB_ENV
          echo "ANDROID_API_LEVEL=31" >> $GITHUB_ENV
          echo "ANDROID_NDK_VERSION=r27c" >> $GITHUB_ENV

      - name: Setup Java (required by Android SDK tools)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Install Android SDK tools and NDK
        run: |
          mkdir -p "$ANDROID_SDK_ROOT"
          sudo apt-get update
          sudo apt-get install -y unzip wget
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
          unzip cmdline-tools.zip -d "$ANDROID_SDK_ROOT"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          mv "$ANDROID_SDK_ROOT/cmdline-tools/"* "$ANDROID_SDK_ROOT/cmdline-tools/latest/"
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"
          yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-${ANDROID_API_LEVEL}" "build-tools;33.0.2" "ndk;${ANDROID_NDK_VERSION}"
          echo "Installed Android SDK and NDK."

      - name: Download and install Qt 6.10 (example)
        run: |
          mkdir -p "$QT_INSTALL_DIR"
          # W CI lepiej użyć offline pakietów lub cache; poniżej przykład pobrania instalatora online
          wget https://download.qt.io/official_releases/online_installers/qt-unified-linux-x64-online.run -O qt-installer.run
          chmod +x qt-installer.run
          # Uwaga: instalator online może wymagać interakcji; w praktyce lepiej użyć offline installerów lub prebuilt Qt w cache
          ./qt-installer.run --help || true
          echo "Qt installer downloaded (dostosuj instalację do własnego procesu CI)."

      - name: Configure build (CMake + Qt6 for Android)
        run: |
          mkdir -p build-android
          cd build-android
          # Dostosuj toolchain i ścieżki Qt zgodnie z rzeczywistą instalacją Qt w CI
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-${ANDROID_API_LEVEL}
            # -DCMAKE_TOOLCHAIN_FILE=$QT_INSTALL_DIR/6.10.0/<android-toolchain-path>/toolchain.cmake \
            # -DQt6_DIR=$QT_INSTALL_DIR/6.10.0/<android-lib-path>/lib/cmake/Qt6

      - name: Build
        run: |
          cd build-android
          cmake --build . -- -j$(nproc)

      - name: Archive APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build-android/*.apk
