name: Android Qt 6.5.3 Build

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      QT_VERSION: 6.5.3
      # Qt 6.5.3 oficjalnie wspiera NDK r25b lub r26. GitHub zazwyczaj ma kilka wersji.
      # Ustawiamy preferowanƒÖ, ale systemowa te≈º powinna zadzia≈Çaƒá.
      ANDROID_ARCH: android_arm64_v8a
      ANDROID_TARGET_SDK: 33

    steps:
      # ############################################################
      # 1Ô∏è‚É£ Checkout repository
      # ############################################################
      - name: Checkout repository
        uses: actions/checkout@v4

      # ############################################################
      # 2Ô∏è‚É£ Setup Java (Wymagane dla Gradle/Android)
      # ############################################################
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ############################################################
      # 3Ô∏è‚É£ Install system dependencies (Ninja)
      # ############################################################
      - name: Install Ninja
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build

      # ############################################################
      # 4Ô∏è‚É£ Install Qt (Android Version)
      # ############################################################
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: 'linux'
          target: 'android'
          arch: ${{ env.ANDROID_ARCH }}
          modules: 'qtwebchannel qtpositioning qtserialport qtcharts qtnetworkauth qt5compat'
          cache: 'true'
          # üëá KLUCZOWA ZMIANA: W≈ÇƒÖcz instalacjƒô modu≈Ç√≥w prywatnych
          include-private-modules: true
      # ############################################################
      # 4b. Dodanie androiddeployqt do PATH
      # ############################################################
      - name: Add androiddeployqt to PATH
        run: |
          # Zmienna ≈õrodowiskowa QT_ROOT jest ustawiana przez jurplel/install-qt-action
          # Zwykle to ≈õcie≈ºka do np. /home/runner/work/repo/Qt/6.5.3/gcc_64
          # Musimy znale≈∫ƒá ≈õcie≈ºkƒô do binari√≥w androida (np. androiddeployqt)
          
          # Zak≈Çadamy, ≈ºe ≈õcie≈ºka wyglƒÖda tak: $QT_ROOT/../android_arm64_v8a/bin
          QT_ANDROID_BIN_PATH=$(find ${{ github.workspace }}/Qt/${{ env.QT_VERSION }}/ -name androiddeployqt -exec dirname {} \;)
          
          if [ -d "$QT_ANDROID_BIN_PATH" ]; then
            echo "Znaleziono ≈õcie≈ºkƒô do androiddeployqt: $QT_ANDROID_BIN_PATH"
            echo "$QT_ANDROID_BIN_PATH" >> $GITHUB_PATH
          else
            echo "B≈ÇƒÖd: Nie znaleziono katalogu bin dla Android Qt."
            exit 1
          fi
      # ############################################################
      # 5Ô∏è‚É£ Configure project with CMake
      # ############################################################
      - name: Configure project (CMake)
        run: |
          # jurplel/install-qt-action automatycznie ustawia PATH do binari√≥w Qt
          # U≈ºywamy qt-cmake, kt√≥ry jest wrapperem dostarczanym przez Qt
          
          qt-cmake -S . -B build-android \
            -G "Ninja" \
            -DANDROID_PLATFORM=android-${{ env.ANDROID_TARGET_SDK }} \
            -DANDROID_ABI=arm64-v8a \
            -DCMAKE_BUILD_TYPE=Release \
            -DQT_ANDROID_BUILD_ALL_ABIS=OFF 
          
          # Uwaga: Qt 6 zazwyczaj samo wykrywa NDK zainstalowane na GitHub Actions.
          # Je≈õli wystƒÖpi b≈ÇƒÖd NDK, mo≈ºna dodaƒá flagƒô: -DANDROID_NDK_ROOT=$ANDROID_NDK_HOME

      # ############################################################
      # 6Ô∏è‚É£ Build project
      # ############################################################
      - name: Build project
        run: cmake --build build-android --parallel

      # ############################################################
      # 7Ô∏è‚É£ Deploy APK (Create APK package)
      # ############################################################
      - name: Build APK using androiddeployqt
        run: |
          # Pe≈Çna ≈õcie≈ºka z≈Ço≈ºona ze zmiennych: github.workspace / Qt / QT_VERSION / android_arm64_v8a / bin / androiddeployqt
          "${{ github.workspace }}/Qt/${{ env.QT_VERSION }}/android_arm64_v8a/bin/androiddeployqt" \
            --input build-android/android-Qt6_deployment_settings.json \
            --output build-android/android-build \
            --android-platform android-${{ env.ANDROID_TARGET_SDK }} \
            --gradle \
            --release

      # ############################################################
      # 8Ô∏è‚É£ Upload APK artifact
      # ############################################################
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: kleiner-brauhelfer-app-android-apk
          # ≈öcie≈ºka zale≈ºy od tego, gdzie gradle wypluje plik. Standardowo w build/outputs
          path: build-android/android-build/build/outputs/apk/release/*.apk
          if-no-files-found: error
