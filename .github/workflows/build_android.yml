name: Android Qt 6.5.3 Build

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      QT_VERSION: 6.5.3
      # Qt 6.5.3 oficjalnie wspiera NDK r25b lub r26. GitHub zazwyczaj ma kilka wersji.
      # Ustawiamy preferowanƒÖ, ale systemowa te≈º powinna zadzia≈Çaƒá.
      ANDROID_ARCH: android_arm64_v8a
      ANDROID_TARGET_SDK: 33

    steps:
      # ############################################################
      # 1Ô∏è‚É£ Checkout repository
      # ############################################################
      - name: Checkout repository
        uses: actions/checkout@v4

      # ############################################################
      # 2Ô∏è‚É£ Setup Java (Wymagane dla Gradle/Android)
      # ############################################################
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ############################################################
      # 3Ô∏è‚É£ Install system dependencies (Ninja)
      # ############################################################
      - name: Install Ninja
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build

      # ############################################################
      # 4Ô∏è‚É£ Install Qt (Android Version)
      # ############################################################
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: 'linux'
          target: 'android'
          arch: ${{ env.ANDROID_ARCH }}
          # üëá DODANO 'qtnetworkauth' NA KO≈ÉCU LISTY
          modules: 'qtwebchannel qtpositioning qtserialport qtcharts qtnetworkauth'
          cache: 'true'

      # ############################################################
      # 5Ô∏è‚É£ Configure project with CMake
      # ############################################################
      - name: Configure project (CMake)
        run: |
          # jurplel/install-qt-action automatycznie ustawia PATH do binari√≥w Qt
          # U≈ºywamy qt-cmake, kt√≥ry jest wrapperem dostarczanym przez Qt
          
          qt-cmake -S . -B build-android \
            -G "Ninja" \
            -DANDROID_PLATFORM=android-${{ env.ANDROID_TARGET_SDK }} \
            -DANDROID_ABI=arm64-v8a \
            -DCMAKE_BUILD_TYPE=Release \
            -DQT_ANDROID_BUILD_ALL_ABIS=OFF 
          
          # Uwaga: Qt 6 zazwyczaj samo wykrywa NDK zainstalowane na GitHub Actions.
          # Je≈õli wystƒÖpi b≈ÇƒÖd NDK, mo≈ºna dodaƒá flagƒô: -DANDROID_NDK_ROOT=$ANDROID_NDK_HOME

      # ############################################################
      # 6Ô∏è‚É£ Build project
      # ############################################################
      - name: Build project
        run: cmake --build build-android --parallel

      # ############################################################
      # 7Ô∏è‚É£ Deploy APK (Create APK package)
      # ############################################################
      - name: Build APK using androiddeployqt
        run: |
          # W Qt6 czƒôsto wystarczy cel 'apk' w cmake, ale androiddeployqt daje wiƒôkszƒÖ kontrolƒô
          androiddeployqt \
            --input build-android/android-Qt6_deployment_settings.json \
            --output build-android/android-build \
            --android-platform android-${{ env.ANDROID_TARGET_SDK }} \
            --gradle \
            --release
            
            # Uwaga: Flaga --release stworzy APK, ale bƒôdzie ono niepodpisane (unsigned),
            # chyba ≈ºe w build.gradle skonfigurowano keystore.

      # ############################################################
      # 8Ô∏è‚É£ Upload APK artifact
      # ############################################################
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: kleiner-brauhelfer-app-android-apk
          # ≈öcie≈ºka zale≈ºy od tego, gdzie gradle wypluje plik. Standardowo w build/outputs
          path: build-android/android-build/build/outputs/apk/release/*.apk
          if-no-files-found: error
