name: Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROID_SDK_ROOT: ${{ github.workspace }}/Android/Sdk
      ANDROID_NDK_ROOT: ${{ github.workspace }}/Android/Sdk/ndk
      QT_VERSION: "6.10.0"
      QT_ARCH: "android_arm64_v8a"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Install Android SDK + NDK
        uses: android-actions/setup-android@v2
        with:
          sdk: |
            platform-tools
            platforms;android-33
            build-tools;33.0.2
          ndk: "26.1.10909125"

      - name: Install Qt 6.10 for Android
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          target: android
          arch: ${{ env.QT_ARCH }}

      - name: Configure with CMake
        run: |
          mkdir build
          cd build
          ${HOME}/Qt/${QT_VERSION}/${QT_ARCH}/bin/qt-cmake \
            -DANDROID_SDK_ROOT=${ANDROID_SDK_ROOT} \
            -DANDROID_NDK_ROOT=${ANDROID_NDK_ROOT} \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=33 \
            -DCMAKE_BUILD_TYPE=Release \
            ..

      - name: Build
        run: |
          cd build
          cmake --build . --parallel

      - name: Deploy APK (androiddeployqt)
        run: |
          cd build
          ${HOME}/Qt/${QT_VERSION}/${QT_ARCH}/bin/androiddeployqt \
            --input android-*/android-*.json \
            --output android-build \
            --aab \
            --apk \
            --release \
            --android-platform android-33 \
            --jdk ${JAVA_HOME}

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: kleiner-brauhelfer-android
          path: build/android-build/*.apk
