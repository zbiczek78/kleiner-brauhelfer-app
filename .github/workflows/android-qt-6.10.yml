name: Android CI Build (Qt 6.5.3) - Linux CI Robust

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    env:
      QT_VERSION: 6.5.3 
      BUILD_DIR: build-android
      PLATFORM_TARGET: android
      ARCH_TARGET: arm64-v8a
      CMAKE_VERBOSE_MAKEFILE: ON
      VERBOSE: 1

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # 1️⃣ Instalacja Qt (desktop, Linux)
    - name: Install Qt (desktop)
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        target: linux
        arch: gcc_64
        dir: ${{ runner.tool_cache }}
        cache: true

    # 2️⃣ Instalacja Android SDK i NDK ręcznie
    - name: Set up Android SDK & NDK
      uses: android-actions/setup-android@v2
      with:
        api-level: 34
        ndk: 25.2.9519653
        # opcjonalnie build-tools: '34.0.0'

    # 3️⃣ Utworzenie katalogu build
    - name: Create build directory
      run: mkdir -p ${{ env.BUILD_DIR }}

    # 4️⃣ Konfiguracja CMake z Qt + Android NDK
    - name: Configure CMake project for Android
      working-directory: ${{ env.BUILD_DIR }}
      shell: bash
      run: |
        set -e

        # Qt paths
        QT_ROOT_DIR="/opt/hostedtoolcache/Qt/${{ env.QT_VERSION }}/gcc_64"
        QT_TOOLCHAIN_FILE="${QT_ROOT_DIR}/lib/cmake/Qt6/qt.toolchain.cmake"

        # Android SDK/NDK paths
        SDK_ROOT="$HOME/Android/Sdk"
        ANDROID_NDK_ROOT="${SDK_ROOT}/ndk/25.2.9519653"
        NDK_TOOLCHAIN_FILE="${ANDROID_NDK_ROOT}/build/cmake/android.toolchain.cmake"

        # Eksport zmiennych środowiskowych
        export JAVA_HOME="$JAVA_HOME"
        export ANDROID_SDK_ROOT="$SDK_ROOT"
        export ANDROID_NDK_ROOT="$ANDROID_NDK_ROOT"

        echo "QT_ROOT_DIR: $QT_ROOT_DIR"
        echo "ANDROID_NDK_ROOT: $ANDROID_NDK_ROOT"

        # Sprawdzenie toolchain
        if [ ! -f "$QT_TOOLCHAIN_FILE" ]; then
          echo "BŁĄD: Nie znaleziono pliku toolchain Qt ($QT_TOOLCHAIN_FILE)."
          exit 1
        fi
        if [ ! -f "$NDK_TOOLCHAIN_FILE" ]; then
          echo "BŁĄD: Nie znaleziono pliku toolchain NDK ($NDK_TOOLCHAIN_FILE)."
          exit 1
        fi

        # Konfiguracja CMake
        cmake .. \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE="$QT_TOOLCHAIN_FILE" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_C_COMPILER=/usr/bin/gcc \
          -DCMAKE_CXX_COMPILER=/usr/bin/g++ \
          -DCMAKE_MAKE_PROGRAM="$(which ninja)" \
          -DQT_CHAINLOAD_TOOLCHAIN_FILE="$NDK_TOOLCHAIN_FILE"

    # 5️⃣ Budowanie paczki Android
    - name: Build Android package
      working-directory: ${{ env.BUILD_DIR }}
      run: cmake --build . --parallel $(nproc)

    # 6️⃣ Upload artefaktu
    - name: Upload Android Artifact (APK/AAB)
      uses: actions/upload-artifact@v4
      with:
        name: android-package-${{ env.QT_VERSION }}-${{ github.sha }}
        path: |
          ${{ env.BUILD_DIR }}/**/*.apk
          ${{ env.BUILD_DIR }}/**/*.aab
        retention-days: 7
