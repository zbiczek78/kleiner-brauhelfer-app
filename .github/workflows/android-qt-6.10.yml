name: Android CI Build (Qt 6.5.3) - Final Configuration

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    # Zmienne środowiskowe
    env:
      QT_VERSION: 6.5.3 
      BUILD_DIR: build-android
      PLATFORM_TARGET: android
      ARCH_TARGET: android_arm64_v8a 
      # Zmienne dla szczegółowych logów kompilacji (zostawiamy dla diagnostyki)
      CMAKE_VERBOSE_MAKEFILE: ON
      VERBOSE: 1

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    # Krok 1: Konfiguracja Javy
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    # Krok 2: Instalacja Qt, Android SDK i NDK (POPRAWKA parametru 'cache')
    - name: Install Qt and Android toolchain
      id: install_qt # Dodajemy ID z powrotem, aby odczytać ścieżkę
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        target: ${{ env.PLATFORM_TARGET }} 
        arch: ${{ env.ARCH_TARGET }}
        dir: ${{ runner.tool_cache }}
        cache: true # POPRAWIONE: Zmieniono 'cached: true' na 'cache: true'
        
    # Krok 3: Przygotowanie katalogu roboczego
    - name: Create build directory
      run: mkdir -p ${{ env.BUILD_DIR }}
      
    # Krok 4: Konfiguracja projektu za pomocą CMake (Powrót do metody Outputs z ID)
    - name: Configure CMake project for Android
      working-directory: ${{ env.BUILD_DIR }}
      shell: bash
      run: |
        # Odczytanie dokładnej ścieżki instalacji Qt z outputs poprzedniego kroku
        QT_BASE_DIR="${{ steps.install_qt.outputs.QT_ROOT_DIR }}"

        # Budowanie ścieżki do pliku toolchain
        # Używamy find wewnątrz katalogu QT_BASE_DIR, aby zlokalizować qt.toolchain.cmake
        QT_TOOLCHAIN_FILE=$(find "$QT_BASE_DIR" -name "qt.toolchain.cmake" | grep "${{ env.ARCH_TARGET }}" | head -n 1)

        echo "QT_BASE_DIR: $QT_BASE_DIR"
        echo "QT_TOOLCHAIN_FILE: $QT_TOOLCHAIN_FILE"

        if [ -z "$QT_TOOLCHAIN_FILE" ]; then
          echo "Błąd: Nie znaleziono pliku toolchain dla Qt ${{ env.QT_VERSION }} w lokalizacji $QT_BASE_DIR."
          # Dodajemy diagnostykę, jeśli ścieżka bazowa jest pusta
          if [ -z "$QT_BASE_DIR" ]; then
            echo "Katalog bazowy QT_BASE_DIR jest pusty. Sprawdź logi akcji 'Install Qt' pod kątem błędów pobierania."
            # Dodatkowa diagnostyka sprawdzająca główne katalogi instalacyjne:
            echo "Dostępne foldery w /opt/hostedtoolcache/Qt/ (jeśli używano 'dir: runner.tool_cache'):"
            ls -R /opt/hostedtoolcache/Qt/
          fi
          exit 1
        fi
        
        # Konfiguracja CMake dla kompilacji Android
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE="$QT_TOOLCHAIN_FILE" \
          -DCMAKE_BUILD_TYPE=Release
          
    # Krok 5: Kompilacja i budowanie paczki Androida
    - name: Build Android package
      working-directory: ${{ env.BUILD_DIR }}
      run: cmake --build . --parallel $(nproc)
      
    # Krok 6: Upload wynikowego artefaktu (APK/AAB)
    - name: Upload Android Artifact (APK/AAB)
      uses: actions/upload-artifact@v4
      with:
        name: android-package-${{ env.QT_VERSION }}-${{ github.sha }}
        path: |
          ${{ env.BUILD_DIR }}/**/*.apk
          ${{ env.BUILD_DIR }}/**/*.aab
        retention-days: 7
