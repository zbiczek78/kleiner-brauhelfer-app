name: Android CI Build (Qt 6.5.3) - Final Configuration

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    # Zmienne środowiskowe
    env:
      QT_VERSION: 6.5.3 
      BUILD_DIR: build-android
      PLATFORM_TARGET: android
      ARCH_TARGET: android_arm64_v8a 
      CMAKE_VERBOSE_MAKEFILE: ON
      VERBOSE: 1

    steps:
    
    - name: Checkout code
      uses: actions/checkout@v4
      
    # Krok 1: Konfiguracja Javy
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    # Krok 2: Instalacja Qt, Android SDK i NDK
    - name: Install Qt and Android toolchain
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        target: ${{ env.PLATFORM_TARGET }} 
        arch: ${{ env.ARCH_TARGET }}
        dir: ${{ runner.tool_cache }}
        cache: true 
        
    # Krok 3: Przygotowanie katalogu roboczego
    - name: Create build directory
      run: mkdir -p ${{ env.BUILD_DIR }}
      
    # Krok 4: Konfiguracja projektu za pomocą CMake (Odnajdywanie ścieżki + NDK w $HOME)
    - name: Configure CMake project for Android
      working-directory: ${{ env.BUILD_DIR }}
      shell: bash
      run: |
        # 1. Odnajdywanie katalogów Qt
        QT_BASE_CACHE_DIR="/opt/hostedtoolcache/Qt/${{ env.QT_VERSION }}"
        QT_INSTALL_DIR=$(find "$QT_BASE_CACHE_DIR" -maxdepth 1 -type d -print -quit)

        # 2. Ustalanie ścieżek Android SDK/NDK (KLUCZOWA ZMIANA: Szukamy w $HOME)
        SDK_ROOT="${HOME}/Android/Sdk"
        NDK_DIR_BASE="${HOME}/Android/Sdk/ndk"

        # Dynamically find the NDK version directory (e.g., ndk/25.2.8791522)
        # NDK jest instalowane jako wersja API lub katalog z datą
        NDK_VERSION_DIR=$(find "$NDK_DIR_BASE" -maxdepth 1 -type d -name "*" -print -quit 2>/dev/null)
        
        # Ostateczne ustawienie NDK_ROOT
        ANDROID_NDK_ROOT="${NDK_VERSION_DIR}"
        NDK_TOOLCHAIN_FILE="${ANDROID_NDK_ROOT}/build/cmake/android.toolchain.cmake"
        
        # Jeśli find zawiódł, użyjemy najbardziej prawdopodobnej domyślnej ścieżki:
        if [ -z "$NDK_VERSION_DIR" ]; then
          # Opcja 1: spróbujmy NDK zainstalowane bezpośrednio w $HOME
          NDK_TOOLCHAIN_FILE=$(find "$HOME" -name "android.toolchain.cmake" | grep "android-ndk" | head -n 1)
          ANDROID_NDK_ROOT=$(dirname $(dirname $(dirname "$NDK_TOOLCHAIN_FILE")))
        fi
        
        # Upewniamy się, że JAVA_HOME jest widoczny
        export JAVA_HOME="$JAVA_HOME" 
        export ANDROID_SDK_ROOT="$SDK_ROOT"
        export ANDROID_NDK_ROOT="$ANDROID_NDK_ROOT"

        # 3. Ustalanie ścieżki do Toolchain Qt
        QT_ROOT_DIR="${QT_INSTALL_DIR}/${{ env.ARCH_TARGET }}"
        QT_TOOLCHAIN_FILE="${QT_ROOT_DIR}/lib/cmake/Qt6/qt.toolchain.cmake"

        echo "ANDROID_NDK_ROOT (Actual): $ANDROID_NDK_ROOT"
        echo "NDK_TOOLCHAIN_FILE (Calculated): $NDK_TOOLCHAIN_FILE"

        if [ ! -f "$QT_TOOLCHAIN_FILE" ]; then
          echo "Błąd: Nie znaleziono pliku toolchain ($QT_TOOLCHAIN_FILE)."
          exit 1
        fi
        
        if [ ! -f "$NDK_TOOLCHAIN_FILE" ]; then
          echo "BŁĄD KRYTYCZNY NDK: Oczekiwany plik NDK toolchain nie istnieje: $NDK_TOOLCHAIN_FILE"
          echo "Zawartość katalogu $HOME/Android/ (diagnostyka):"
          ls -R "$HOME/Android/" 2>/dev/null || echo "Katalog $HOME/Android/ nie istnieje lub nie jest dostępny."
          exit 1
        fi

        # 4. Konfiguracja CMake
        cmake .. \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE="$QT_TOOLCHAIN_FILE" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_C_COMPILER=/usr/bin/gcc \
          -DCMAKE_CXX_COMPILER=/usr/bin/g++ \
          -DCMAKE_MAKE_PROGRAM="$(which ninja)" \
          -DQT_CHAINLOAD_TOOLCHAIN_FILE="$NDK_TOOLCHAIN_FILE"
          
    # Krok 5: Kompilacja i budowanie paczki Androida
    - name: Build Android package
      working-directory: ${{ env.BUILD_DIR }}
      run: cmake --build . --parallel $(nproc)
      
    # Krok 6: Upload wynikowego artefaktu (APK/AAB)
    - name: Upload Android Artifact (APK/AAB)
      uses: actions/upload-artifact@v4
      with:
        name: android-package-${{ env.QT_VERSION }}-${{ github.sha }}
        path: |
          ${{ env.BUILD_DIR }}/**/*.apk
          ${{ env.BUILD_DIR }}/**/*.aab
        retention-days: 7
