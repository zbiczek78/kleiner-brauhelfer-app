name: Android Build (Qt 6.10)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-android:
    runs-on: ubuntu-22.04

    env:
      QT_VERSION: 6.10.0
      ANDROID_NDK_VERSION: "26.1.10909125"
      ANDROID_API_LEVEL: "33"
      BUILD_TOOLS_VERSION: "33.0.2"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # ------------------------------
    # Install Qt 6.10 for Android
    # ------------------------------
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: linux
        target: android
        arch: android_arm64_v8a
        modules: qtcharts qtquickcontrols2 qtmultimedia qt5compat
        cache: true

    # ------------------------------
    # Install Android cmdline-tools (TOOLS, no LATEST)
    # ------------------------------
    - name: Install Android cmdline-tools
      run: |
        mkdir -p "$ANDROID_HOME/cmdline-tools"
        cd "$ANDROID_HOME/cmdline-tools"
        # remove only our tools folder, never touch preinstalled 'latest'
        rm -rf tools
        wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O tools.zip
        mkdir tools
        unzip tools.zip -d tools
        rm tools.zip
        export PATH=$ANDROID_HOME/cmdline-tools/tools/bin:$PATH

    # ------------------------------
    # Install Android SDK packages
    # ------------------------------
    - name: Install Android packages
      run: |
        yes | $ANDROID_HOME/cmdline-tools/tools/bin/sdkmanager --licenses
        yes | $ANDROID_HOME/cmdline-tools/tools/bin/sdkmanager \
          "platform-tools" \
          "platforms;android-${ANDROID_API_LEVEL}" \
          "build-tools;${BUILD_TOOLS_VERSION}" \
          "ndk;${ANDROID_NDK_VERSION}"

    # ------------------------------
    # Configure environment for Qt Android builds
    # ------------------------------
    - name: Configure Qt for Android
      run: |
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/${ANDROID_NDK_VERSION}" >> $GITHUB_ENV
        echo "JAVA_HOME=$JAVA_HOME_17_X64" >> $GITHUB_ENV
        echo "$ANDROID_HOME/cmdline-tools/tools/bin" >> $GITHUB_PATH

    # ------------------------------
    # CMake configure
    # ------------------------------
    - name: Configure CMake
      run: |
        mkdir -p build-android
        cd build-android
        cmake .. \
          -GNinja \
          -DCMAKE_BUILD_TYPE=Release \
          -DQT_HOST_PATH="$Qt6_DIR/.." \
          -DCMAKE_TOOLCHAIN_FILE="$Qt6_DIR/../android_arm64_v8a/lib/cmake/Qt6/qt.toolchain.cmake" \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-${ANDROID_API_LEVEL}

    # ------------------------------
    # Build APK
    # ------------------------------
    - name: Build Android APK
      run: |
        cd build-android
        ninja apk

    # ------------------------------
    # Upload resulting APK
    # ------------------------------
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: kleiner-brauhelfer-app-apk
        path: build-android/*.apk
