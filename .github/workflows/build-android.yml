name: Android Build (Qt 6.10)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-android:
    runs-on: ubuntu-22.04

    env:
      QT_VERSION: 6.10.0
      QT_ANDROID_ABIS: "arm64-v8a"
      ANDROID_NDK_VERSION: "26.1.10909125"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # ------------------------------
    # Install Qt 6.10 Android
    # ------------------------------
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: linux
        target: android
        arch: android_arm64_v8a
        modules: qtcharts qtquickcontrols2 qtmultimedia qt5compat
        cache: true

    # ------------------------------
    # Install Android command line tools
    # ------------------------------
    - name: Install Android cmdline-tools
      run: |
        mkdir -p "$ANDROID_HOME/cmdline-tools"
        cd "$ANDROID_HOME/cmdline-tools"
        wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O tools.zip
        mkdir latest
        unzip tools.zip -d latest
        rm tools.zip

    # ------------------------------
    # Install Android packages
    # ------------------------------
    - name: Install Android packages
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
          "platform-tools" \
          "platforms;android-33" \
          "build-tools;33.0.2" \
          "ndk;${ANDROID_NDK_VERSION}"

    # ------------------------------
    # Configure Qt environment variables
    # ------------------------------
    - name: Configure Qt for Android
      run: |
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/${ANDROID_NDK_VERSION}" >> $GITHUB_ENV
        echo "JAVA_HOME=$JAVA_HOME_17_X64" >> $GITHUB_ENV

    # ------------------------------
    # CMake Configure
    # ------------------------------
    - name: Configure CMake
      run: |
        mkdir -p build-android
        cd build-android
        cmake .. \
          -GNinja \
          -DCMAKE_BUILD_TYPE=Release \
          -DQT_HOST_PATH="$Qt6_DIR/.." \
          -DCMAKE_TOOLCHAIN_FILE="$Qt6_DIR/../android_arm64_v8a/lib/cmake/Qt6/qt.toolchain.cmake" \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-33

    # ------------------------------
    # Build with Ninja
    # ------------------------------
    - name: Build Android APK
      run: |
        cd build-android
        ninja apk

    # ------------------------------
    # Upload artifacts
    # ------------------------------
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: kleiner-brauhelfer-app-apk
        path: build-android/*.apk
